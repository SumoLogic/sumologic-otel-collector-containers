#################################################################################
# A reusable workflow to push container images to various image registries such
# as Amazon ECR & Docker Hub.
#################################################################################

on:
  workflow_call:
    inputs:
      target:
        description: |
          The name of the bake target to create tags for.
        type: string
        required: true
      tags:
        description: |
          A list of tags (in JSON format) to create for the source images.
        type: string
        required: true
      version:
        description: The version of OTC the images are for.
        type: string
        required: true
    secrets:
      aws-access-key-id:
        required: true
      aws-secret-access-key:
        required: true

defaults:
  run:
    shell: bash

jobs:
  push:
    name: Push
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.6.0

      - name: Set up Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3.10.0

      - name: Show Buildx platforms
        run: echo ${{ steps.buildx.outputs.platforms }}

      - name: Login to ECR
        uses: docker/login-action@v3
        with:
          registry: 663229565520.dkr.ecr.us-east-1.amazonaws.com
          username: ${{ secrets.aws-access-key-id }}
          password: ${{ secrets.aws-secret-access-key }}

      - uses: actions/download-artifact@v4
        with:
          pattern: "manifest_${{ inputs.target }}_*"
          path: manifests
          merge-multiple: true

      - name: Determine source images (ECR)
        run: |
          jq -jf ci/jq/manifest-sources.jq --arg target ${{ inputs.target }} \
          manifests/*-ecr.json | tee sources-ecr.txt

      - name: Determine tags (ECR)
        env:
          REPO_BASE: 663229565520.dkr.ecr.us-east-1.amazonaws.com
          REPO_ORG: sumologic
          REPO_NAME: sumologic-otel-collector-ci-builds
        run: |
          REPO="${REPO_BASE}/${REPO_ORG}/${REPO_NAME}"
          echo '${{ inputs.tags }}' | jq -jf ci/jq/tags.jq --arg url "$REPO" > ecr-tags.txt

      - name: Create multiplatform image index (ECR)
        run: |
          while IFS= read -r tag; do
            docker manifest create "${tag}" "$(cat sources-ecr.txt)"
            docker manifest push "${tag}"
          done < ecr-tags.txt
