#################################################################################
# A reusable workflow to push container images to various image registries such
# as Amazon ECR & Docker Hub.
#################################################################################

name: Workflow - Push Container Indexes

on:
  workflow_call:
    inputs:
      git-ref:
        description: |
          The git reference used to build the collector. This is used to tag the
          container images with the git commit SHA.
        type: string
        required: true
      version:
        description: |
          The version of the collector to use for tagging the container images.
          This is used to tag the container images with the version of the
          collector.
        type: string
        required: true
    secrets:
      aws-access-key-id:
        description: |
          The AWS access key ID used to authenticate with Amazon ECR.
          This should be stored as a GitHub secret.
        required: true
      aws-secret-access-key:
        description: |
          The AWS secret access key used to authenticate with Amazon ECR.
          This should be stored as a GitHub secret.
        required: true

defaults:
  run:
    shell: bash

jobs:
  push:
    name: ${{ matrix.target }}
    uses: ./.github/workflows/workflow-push-container-index.yml
    strategy:
      matrix:
        include:
          - target: standard
            tags: >
              [
              "latest",
              "${{ github.sha }}",
              "${{ inputs.git-ref }}",
              "${{ inputs.version }}"
              ]
          - target: standard-fips
            tags: >
              [
              "latest-fips",
              "${{ github.sha }}-fips",
              "${{ inputs.git-ref }}-fips",
              "${{ inputs.version }}-fips"
              ]
          - target: ubi
            tags: >
              [
              "latest-ubi",
              "${{ github.sha }}-ubi",
              "${{ inputs.git-ref }}-ubi",
              "${{ inputs.version }}-ubi"
              ]
          - target: ubi-fips
            tags: >
              [
              "latest-ubi-fips",
              "${{ github.sha }}-ubi-fips",
              "${{ inputs.git-ref }}-ubi-fips",
              "${{ inputs.version }}-ubi-fips"
              ]
    with:
      tags: ${{ matrix.tags }}
      target: ${{ matrix.target }}
    secrets:
      aws-access-key-id: ${{ secrets.aws-access-key-id }}
      aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
